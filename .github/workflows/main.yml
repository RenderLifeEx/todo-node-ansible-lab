name: Deploy to production server
on:
  push:
    branches:
      - master
    tags:
      - '**-prod**'

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Start Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            *‚ôªÔ∏è –î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω*
            *üåç –°–µ—Ä–≤–µ—Ä:* –ú–µ—á—Ç–∞
            *üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:* ¬´jQuery Todo¬ª
            *üõ†Ô∏è –¢–∏–ø:* Backend

      - name: Git clone repository
        uses: actions/checkout@v4

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20.x (LTS)
      - name: Setup Node.js
        uses: actions/checkout@v4
        with:
          node-version: 'lts/iron'
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies with pnpm
        run: pnpm install

      - name: Compile ts to js
        run: pnpm run build

      - name: Create BZIP deployment package
        run: tar -cjf appBackend.tar.bz2 ./*

      - name: Copy file to serve
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: appBackend.tar.bz2
          target: ~/uploads/

      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            cd /var/www/${{ secrets.BACKEND_FOLDER }}
            kill -9 $(lsof -t -i:1337)

            # –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫—Ä–æ–º–µ –ø–∞–ø–∫–∏ node_modules –∏ public
            ls | grep -v "\(node_modules\|db\)" | xargs rm -rfv

            # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
            tar -C ./ -xjf ~/uploads/appBackend.tar.bz2 --strip-components 1
            rm -rf ~/uploads/appBackend.tar.bz2

            # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            if [ ! -f ".env" ]; then
              cp .env.development.local .env
              echo "‚úÖ .env —Å–æ–∑–¥–∞–Ω –∏–∑ dev –≤–µ—Ä—Å–∏–∏"
            fi

            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            pnpm install

            # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            docker compose up -d

            # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π-
            pnpm run migrate

            # –ò–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ ecosystem.config.js
            APP_NAME="todo-backend"

            # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
            if pm2 list | grep -q $APP_NAME; then
              pm2 stop $APP_NAME
              pm2 delete $APP_NAME
            else
              echo "Process $APP_NAME not found, skipping..."
            fi

            # –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞
            pm2 start /var/www/${{ secrets.BACKEND_FOLDER }}/ecosystem.config.js --env production

      - name: Success Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            *‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω*
            *üåç –°–µ—Ä–≤–µ—Ä:* –ú–µ—á—Ç–∞
            *üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:* ¬´jQuery Todo¬ª
            *üõ†Ô∏è –¢–∏–ø:* Backend
            *–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:* _${{ github.event.commits[0].message }}_

      - name: Failed Notification
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            *‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–µ—É–¥–∞—á–µ–π*
            *üåç –°–µ—Ä–≤–µ—Ä:* –ú–µ—á—Ç–∞
            *üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:* ¬´jQuery Todo¬ª
            *üõ†Ô∏è –¢–∏–ø:* Backend
            *–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:* _${{ github.event.commits[0].message }}_
