name: Deploy to production server
on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Git clone repository
        uses: actions/checkout@v2

      - name: Node install
        uses: actions/setup-node@v2
        with:
          node-version: "lts/fermium"

      - name: List
        run: ls

      - name: Install dependencies with Yarn
        run: yarn install

      - name: Build admin panel
        run: NODE_ENV=production yarn build

      - name: Create BZIP deployment package
        run: tar -cjf app.tar.bz2 ./*

      - name: Copy file to serve
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: app.tar.bz2
          target: ~/uploads/

      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            cd ~/back/
            kill -9 $(lsof -t -i:1337)

            # –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫—Ä–æ–º–µ –ø–∞–ø–∫–∏ node_modules –∏ public
            ls | grep -v "\(node_modules\|public\)" | xargs rm -rfv

            # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
            tar -C ./ -xjf ~/uploads/app.tar.bz2 --strip-components 1
            rm -rf ~/uploads/app.tar.bz2

            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            cp config/database.example.js config/database.js

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            yarn install

            # –ò–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ ecosystem.config.js
            APP_NAME="is-salary"

            # –ü–æ–∏—Å–∫ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è pm2
            whereis pm2

            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
            ~/.nvm/versions/node/v10.19.0/bin/pm2 stop $APP_NAME || true
            ~/.nvm/versions/node/v10.19.0/bin/pm2 delete $APP_NAME || true

            # –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞
            ~/.nvm/versions/node/v10.19.0/bin/pm2 start ~/back/ecosystem.config.js --env production

      - name: Success Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            üéâ –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ¬´jQuery Todo - üõ†Ô∏è Backend
            –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ú–µ—á—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.
            –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${{ github.event.commits[0].message }}

      - name: Failed Notification
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            üî• –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ¬´jQuery Todo - üõ†Ô∏è Backend
            –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ú–µ—á—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–µ—É–¥–∞—á–µ–π.
            –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${{ github.event.commits[0].message }}
